# Аудит кода Thalex Rust SDK

## Обзор проекта

Thalex Rust SDK - это клиентская библиотека для работы с WebSocket API биржи Thalex. Проект предоставляет асинхронный клиент для подключения к WebSocket API, выполнения RPC-запросов и подписки на каналы данных в реальном времени.

## Архитектура и компоненты

### 1. Основные модули

#### `src/lib.rs`
Главный модуль библиотеки, экспортирует:
- `models` - модели данных
- `ws_client` - WebSocket клиент

#### `src/ws_client.rs`
Основной модуль, содержащий реализацию WebSocket клиента.

**Ключевые компоненты:**

- **`WsClient`** - публичный API клиента
  - `connect_default()` / `connect()` - подключение к WebSocket
  - `call_rpc()` - выполнение JSON-RPC запросов
  - `subscribe()` / `unsubscribe()` - подписка/отписка от каналов
  - `shutdown()` - корректное завершение работы

- **`connection_supervisor`** - супервизор соединения
  - Автоматическое переподключение при разрыве соединения
  - Повторная подписка на активные каналы после переподключения
  - Обработка ошибок подключения с экспоненциальной задержкой (3 секунды)

- **`run_single_connection`** - обработка одного соединения
  - Обработка входящих сообщений (Text, Binary, Ping/Pong, Close)
  - Отправка команд через канал
  - Обработка shutdown сигналов

- **`handle_incoming`** - обработка входящих сообщений
  - Парсинг JSON
  - Маршрутизация RPC-ответов по ID
  - Маршрутизация подписок по channel_name

#### `src/models/`
Модели данных, сгенерированные из OpenAPI спецификации:

- **`Delay`** - enum для интервалов обновления (100ms, 200ms, 500ms, 1000ms, 5000ms, 60000ms, raw)
- **`TickerData`** - структура данных тикера с полями:
  - Цены bid/ask и их объемы
  - Последняя цена сделки
  - Mark price и timestamp
  - IV, delta, index, forward (для опционов)
  - Объемы и статистика за 24 часа
  - Funding rate (для перпетуалов)
  - Open interest, price collars
- **`TickerResponse`** - обертка для ответа подписки с channel_name и notification

### 2. Потоки данных

#### RPC запросы (request-response)
1. Клиент вызывает `call_rpc(method, params)`
2. Генерируется уникальный ID через `AtomicU64`
3. Создается `oneshot::channel` для ответа
4. Запрос добавляется в `pending_requests` HashMap
5. Сообщение отправляется через WebSocket
6. При получении ответа с соответствующим ID, ответ отправляется через oneshot channel
7. Таймаут 30 секунд на ожидание ответа

#### Подписки (pub-sub)
1. Клиент вызывает `subscribe(channel, callback)`
2. Создается `mpsc::unbounded_channel` для канала
3. Подписка добавляется в `subscriptions` HashMap
4. Отправляется команда подписки на сервер
5. Создается отдельная задача для обработки callback
6. При получении сообщения с `channel_name`, оно отправляется в соответствующий канал
7. Callback вызывается в отдельной задаче

### 3. Управление соединением

**Супервизор соединения:**
- Бесконечный цикл переподключения
- При разрыве соединения:
  - Все pending RPC запросы помечаются как failed
  - Активные подписки сохраняются
  - После переподключения автоматически восстанавливаются все подписки
- Задержка переподключения: 3 секунды (фиксированная)

**Обработка одного соединения:**
- Использует `tokio::select!` для мультиплексирования:
  - Shutdown сигналы
  - Команды на отправку
  - Входящие WebSocket сообщения
- Обрабатывает Ping/Pong для keepalive
- Корректно закрывает соединение при shutdown

## Используемые технологии

- **tokio** - асинхронный runtime
- **tokio-tungstenite** - WebSocket клиент
- **futures-util** - утилиты для работы с futures
- **serde/serde_json** - сериализация/десериализация JSON
- **log/simple_logger** - логирование

## Паттерны проектирования

1. **Supervisor Pattern** - супервизор управляет жизненным циклом соединения
2. **Actor Pattern** - команды отправляются через каналы
3. **Pub-Sub Pattern** - подписки на каналы данных
4. **Request-Response Pattern** - RPC вызовы

## Примеры использования

См. `examples/subscribe.rs`:
- Подключение к WebSocket
- Выполнение RPC запроса `public/instruments`
- Подписка на канал `ticker.BTC-PERPETUAL.100ms`
- Ожидание 60 секунд
- Корректное завершение

