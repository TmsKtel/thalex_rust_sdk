# Thalex Rust SDK — Audit docs recheck (v5)

Проверка выполнена по архиву `thalex_rust_sdk5.tgz`.

Цель: найти, что **ещё осталось неисправленным/некорректным в отчётах** в `audit/` (исходный код `src/` не меняем).

## Итог

- **Критические противоречия из прошлого ревью (про строковый JSON-RPC `id` и `lock across await` в `resubscribe_all`) в основных отчётах в целом закрыты.**
- Однако есть **несколько оставшихся мест**, где отчёты либо (a) содержат устаревшие детали по текущему коду, либо (b) дают примеры, которые можно сделать точнее/чище.

## 1) Устаревшие детали в `performance_analysis.md` и `performance_analysis_en.md`

Эти файлы до сих пор выглядят как самый "старый" слой аудита: они:
- оперируют **одним** `subscriptions`, тогда как текущий код использует `public_subscriptions` и `private_subscriptions` (в `ws_client.rs`);
- активно ссылаются на **номера строк**, которые с высокой вероятностью уже не соответствуют актуальному `ws_client.rs` (например, перечисления вроде `send_rpc: строки 205, 222`, `handle_incoming: 671, 682`, `resubscribe_all: 382-413` и т.п.).

**Что исправить в отчёте:**
1. Везде, где говорится про `subscriptions`, уточнить: "public/private subscriptions" (или "две таблицы подписок").
2. Либо убрать абсолютные номера строк, либо заменить их на **поиск по символам/именам** (например: `handle_incoming()` → блок `pending_requests.lock()` и блок маршрутизации по `channel_name`).
3. Добавить короткую ремарку, что файлы `*_recheck_report_*` и `*_perf_addendum_*` — исторические документы, а `performance_analysis*` описывает общие паттерны, если вы решите не актуализировать строчные ссылки.

## 2) Дубли/шероховатости в рекомендациях по "fast pre-check" для `id`

В нескольких документах (например, `optimization_recommendations.md`, `FINAL_REPORT.md`, `implementation_examples.md`) fast pre-check выглядит примерно как:

```rust
if text.contains("\"id\":") || text.find("\"id\":").is_some() {
    // ...
}
```

Это **не ошибка**, но это **дублирование**: `contains()` уже эквивалентен `find().is_some()`.
Также местами остаётся "оговорка", что `id` может быть строкой — для JSON-RPC обычно это число (или `null`), так что лучше формулировать: "`id` обычно число; мы ищем маркер `"id":` и затем проверяем `as_u64()`".

**Что поправить в отчёте:** заменить на один вариант (например, только `contains("\"id\":")`).

## 3) Не везде явно отражено, что в коде уже есть snapshot ключей в `resubscribe_all`

В новых документах это отражено корректно, но есть риск, что читатель откроет старый файл (`performance_analysis*`) и увидит старое описание. Хорошо бы унифицировать: либо обновить `performance_analysis*`, либо в начале добавить яркую ремарку "см. `thalex_rust_sdk_performance_reaudit_2025*` как актуальную версию".

## 4) Согласованность RU/EN версий

По структуре RU/EN в целом синхронизированы, но **любые правки выше** стоит внести **в оба файла** (`performance_analysis.md` и `performance_analysis_en.md`), иначе снова появится расхождение.

## 5) Что не требуется исправлять (это нормально)

- Наличие прошлых ревью-файлов `thalex_rust_sdk_audit_*` в `audit/` — ок, это история.
- Упоминания вида `"id":"123"` встречаются **в поясняющем тексте** как пример того, как *не должно быть* — это нормально.

## Рекомендуемый минимальный набор правок в audit

1) Обновить `performance_analysis.md` + `performance_analysis_en.md` (п.1–3 выше).
2) Почистить дублирующиеся проверки `contains/find` в примерах (п.2).
3) При необходимости — добавить в `FILES_INDEX(.md|_en.md)` пометку, какие документы считать "актуальными" (например, `*_performance_reaudit_2025*`, `FINAL_REPORT*`).
